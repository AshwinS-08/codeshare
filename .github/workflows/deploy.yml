name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies (backend)
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install pytest flake8
    
    - name: Test application (backend)
      run: |
        python -m pytest -v backend/tests || echo "No tests found, skipping test step"
    
    - name: Lint backend with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names (backend only)
        flake8 backend --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 backend --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install EB CLI
      run: |
        python -m pip install --upgrade pip
        pip install awsebcli
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Create deployment package from backend
      run: |
        cd backend
        zip -r ../deploy.zip .
    
    - name: Create EB CLI configuration (backend)
      run: |
        cd backend
        mkdir -p .elasticbeanstalk
        cat > .elasticbeanstalk/config.yml << EOF
        branch-defaults:
          main:
            environment: ${{ secrets.EB_ENVIRONMENT_NAME }}
            group_suffix: null
        global:
          application_name: ${{ secrets.EB_APPLICATION_NAME }}
          branch: null
          default_ec2_keyname: null
          default_platform: python-3.8
          default_region: ${{ secrets.AWS_REGION }}
          include_git_submodules: true
          instance_profile: null
          platform_name: null
          platform_version: null
          profile: null
          repository: null
          sc: git
          workspace_type: Application
        EOF

    - name: Update EB environment variables (backend)
      run: |
        # Set environment variables on the EB environment from GitHub Repository Variables
        # NOTE: For sensitive values, prefer GitHub Secrets over Variables.
        cd backend
        eb setenv \
          SUPABASE_URL=${{ vars.SUPABASE_URL }} \
          SUPABASE_SERVICE_ROLE_KEY=${{ vars.SUPABASE_SERVICE_ROLE_KEY }} \
          SUPABASE_ANON_KEY=${{ vars.SUPABASE_ANON_KEY }} \
          SECRET_KEY=${{ vars.SECRET_KEY }}
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
    
    - name: Deploy to Elastic Beanstalk (backend)
      run: |
        # Deploy the backend folder to the existing environment
        cd backend
        eb deploy ${{ secrets.EB_ENVIRONMENT_NAME }} --timeout 20
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
    
    - name: Get deployment URL (backend)
      run: |
        echo "Application deployed successfully!"
        cd backend
        eb status ${{ secrets.EB_ENVIRONMENT_NAME }} | grep "CNAME" || echo "Deployment completed!"